name: Monitor de Chamados

concurrency:
  group: monitor-de-chamados
  cancel-in-progress: false

on:
  schedule:
    - cron: "*/5 17-22 * * *" # 14h-20h BRT (17h-23h UTC)
    - cron: "*/5 0-1 * * *"   # ContinuaÃ§Ã£o atÃ© 02h UTC (23h BRT)
  workflow_dispatch: # permite rodar manualmente

jobs:
  mascara-atendimento:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ“‚ Instalar dependÃªncias
        run: npm install

      # ðŸš€ Rodar monitor de novos chamados
      # - name: ðŸš€ Rodar chamados-novos
      #   run: node monitores/chamados-novos.js
      #   env:
      #     MS_USER: ${{ secrets.MS_USER }}
      #     MS_PASS: ${{ secrets.MS_PASS }}
      #     TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      #     TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ðŸš€ Rodar monitor mascara-atendimento
        run: node monitores/mascara-atendimento.js
        env:
          MS_USER: ${{ secrets.MS_USER }}
          MS_PASS: ${{ secrets.MS_PASS }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

  sla-vencimentos:
    runs-on: ubuntu-latest
    needs: mascara-atendimento
    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ“‚ Instalar dependÃªncias
        run: npm install

      - name: ðŸš¨ Rodar monitor de SLA
        run: node monitores/monitor-sla.js
        env:
          MS_USER: ${{ secrets.MS_USER }}
          MS_PASS: ${{ secrets.MS_PASS }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
